<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#060B14" />
  <title>Install | ApexView</title>
  <meta name="description" content="Install ApexView via TestFlight. iPhone only." />
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main class="container" style="padding:72px 0; max-width:820px;">
    <a class="brand" href="/" style="text-decoration:none; display:inline-flex; gap:10px; align-items:center;">
      <img src="assets/logo.png" alt="ApexView logo" class="brand-mark" />
      <span class="brand-name">ApexView</span>
    </a>

    <div class="card" style="margin-top:18px;">
      <h1 style="margin:0 0 10px 0;">Install ApexView (TestFlight)</h1>
      <p class="muted" style="margin:0 0 18px 0;">
        ApexView is iPhone-only. Enter your name and email to get beta updates, then we’ll send you to TestFlight.
      </p>

      <div id="platformNote" class="note" style="display:none; margin-bottom:14px;"></div>
      <div id="status" class="note" style="display:none; margin-bottom:14px;"></div>

      <form id="installForm" class="simple-form" style="display:grid; gap:10px; max-width:520px;">
        <label class="sr-only" for="firstName">First name</label>
        <input id="firstName" name="FNAME" type="text" placeholder="First name" autocomplete="given-name" required />

        <label class="sr-only" for="lastName">Last name</label>
        <input id="lastName" name="LNAME" type="text" placeholder="Last name" autocomplete="family-name" required />

        <label class="sr-only" for="email">Email address</label>
        <input id="email" name="EMAIL" type="email" placeholder="you@example.com" autocomplete="email" required />

        <!-- Honeypot (bots only). If filled, we do nothing. -->
        <div aria-hidden="true" style="position:absolute; left:-5000px;">
          <input type="text" id="hp" name="hp" tabindex="-1" value="">
        </div>

        <button id="submitBtn" class="btn btn-primary" type="submit">Continue to TestFlight →</button>

        <p class="muted" style="margin:4px 0 0 0; font-size:13px;">
          By continuing, you agree to receive beta updates about ApexView. Unsubscribe anytime.
        </p>
        <p class="muted" style="margin:6px 0 0 0; font-size:13px;">
          <a href="privacy.html" class="inline-link">Privacy Policy</a>
        </p>
      </form>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
        <a class="btn btn-ghost" href="/">Back to home</a>
        <a class="btn btn-ghost" href="https://testflight.apple.com/join/hd8jdvmE" target="_blank" rel="noopener">Skip and open TestFlight</a>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const TESTFLIGHT_URL = "https://testflight.apple.com/join/hd8jdvmE";

      // Mailchimp JSONP endpoint (same audience as your form, just "post-json" instead of "post")
      // Your existing action:
      // https://apexviewapp.us20.list-manage.com/subscribe/post?u=0c8e243ed65530b5a7adcc376&id=31da0cdd81&f_id=005a5eeef0
      // JSONP version:
      const MAILCHIMP_JSONP = "https://apexviewapp.us20.list-manage.com/subscribe/post-json";
      const MC_U = "0c8e243ed65530b5a7adcc376";
      const MC_ID = "31da0cdd81";

      const ua = navigator.userAgent || "";
      const isIOS = /iPhone|iPad|iPod/i.test(ua);

      const platformNote = document.getElementById("platformNote");
      const status = document.getElementById("status");
      const form = document.getElementById("installForm");
      const btn = document.getElementById("submitBtn");

      if (!isIOS) {
        platformNote.style.display = "block";
        platformNote.textContent = "This beta is for iPhone only. Open this page on your iPhone to install via TestFlight.";
      }

      function setStatus(msg) {
        if (!status) return;
        status.style.display = "block";
        status.textContent = msg;
      }

      function redirectToTestFlight() {
        window.location.href = TESTFLIGHT_URL;
      }

      // JSONP helper
      function jsonp(url) {
        return new Promise((resolve) => {
          const cbName = "mc_cb_" + Math.random().toString(16).slice(2);
          window[cbName] = function (data) {
            try { delete window[cbName]; } catch (_) {}
            script.remove();
            resolve(data);
          };

          const script = document.createElement("script");
          script.src = url + "&c=" + cbName;
          document.body.appendChild(script);
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // honeypot: if filled, treat as bot and just do nothing (or redirect)
        const hp = document.getElementById("hp");
        if (hp && hp.value) {
          redirectToTestFlight();
          return;
        }

        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const email = document.getElementById("email").value.trim();

        if (!firstName || !lastName || !email) return;

        btn.disabled = true;
        setStatus("Saving your email, then opening TestFlight...");

        // Build JSONP URL
        const params = new URLSearchParams();
        params.set("u", MC_U);
        params.set("id", MC_ID);
        params.set("EMAIL", email);
        params.set("FNAME", firstName);
        params.set("LNAME", lastName);

        // Mailchimp expects this param for JSONP
        // (some lists need it, safe to include)
        params.set("b_" + MC_U + "_" + MC_ID, "");

        const url = MAILCHIMP_JSONP + "?" + params.toString();

        try {
          const data = await jsonp(url);

          // Mailchimp returns { result: "success"|"error", msg: "..." }
          // Even if "already subscribed", we still want to continue.
          if (data && (data.result === "success" || data.result === "error")) {
            redirectToTestFlight();
            return;
          }

          // fallback
          redirectToTestFlight();
        } catch (err) {
          redirectToTestFlight();
        }
      });
    })();
  </script>
</body>
</html>
